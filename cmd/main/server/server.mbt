///|
const DESKFLOW_APP_NAME = "Deskflow"

///|
const DESKFLOW_APP_PATH = "/Applications/Deskflow.app"

///|
pub async fn run(server_config : @common.ServerConfig) -> Unit {
  if @lib.match_platform([Windows, Linux]) {
    println("æš‚ä¸æ”¯æŒWindowsã€Linuxä½œä¸ºæœåŠ¡ç«¯")
    return
  }
  while true {
    println("ç­‰å¾…é”å±...")
    @lib.lock_listen(@lib.LockState::Locked)
    println("å·²é”å±ğŸ”’ï¼Œé€šçŸ¥å…¶å®ƒå®¢æˆ·ç«¯é”å±å¹¶å…³é—­Deskflow")
    notify_to_all_clients(server_config)
    stop_app(DESKFLOW_APP_NAME)
    println("ç­‰å¾…è§£é”...")
    @lib.lock_listen(@lib.LockState::UnLocked)
    println("å·²è§£é”ğŸ”“")
    // è§£é”åå»¶è¿Ÿå¯åŠ¨åº”ç”¨ï¼Œé˜²æ­¢æ— æ³•å¯åŠ¨åº”ç”¨
    @async.sleep(2000)
    start_app(DESKFLOW_APP_NAME, DESKFLOW_APP_PATH)
    @async.pause()
  }
}

///|
async fn notify_to_all_clients(server_config : @common.ServerConfig) -> Unit {
  for client in server_config.clients {
    let { name, url } = client
    let headers = {}
    headers[@client.AUTHORIZATION_KEY] = "\{@client.AUTHORIZATION_VALUE_PREFIX}\{server_config.token}"
    let (res, data) = @http.post(url, b"", headers~) catch {
      e => {
        println("è¯·æ±‚ \{url} å¤±è´¥: \{e}")
        continue
      }
    }
    if res.code == 200 {
      println("é€šçŸ¥å®¢æˆ·ç«¯ \{name}(\{url}) æˆåŠŸ")
    } else {
      println(
        "é€šçŸ¥å®¢æˆ·ç«¯ \{name}(\{url}) å¤±è´¥: \{res.reason} | \{data.text()}",
      )
    }
  }
}
